import React, { useState, useMemo } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from 'recharts';

// --- 데이터 영역 ---

// 대한민국 주요 도시 위도/경도 및 색상
const cityInfo = {
  '서울': { lat: 37.5665, lon: 126.9780, color: '#FF6384' }, // Rose
  '부산': { lat: 35.1796, lon: 129.0756, color: '#36A2EB' }, // Blue
  '대구': { lat: 35.8714, lon: 128.6014, color: '#FFCE56' }, // Yellow
  '광주': { lat: 35.1601, lon: 126.8515, color: '#4BC0C0' }, // Teal
  '강릉': { lat: 37.7519, lon: 128.8761, color: '#9966FF' }, // Purple
  '제주': { lat: 33.4996, lon: 126.5312, color: '#FF9F40' }, // Orange
  '대전': { lat: 36.3504, lon: 127.3845, color: '#2ECC71' }, // Green
  '인천': { lat: 37.4563, lon: 126.7052, color: '#E74C3C' }, // Red
};

// 기상청 데이터를 기반으로 한 최근 10년간의 장마철(6월~7월) 샘플 데이터
const mockWeatherData = {
  '서울': [ { year: 2015, precipitation: 280, temp: 24.5, humidity: 78 }, { year: 2016, precipitation: 350, temp: 25.1, humidity: 82 }, { year: 2017, precipitation: 450, temp: 25.5, humidity: 85 }, { year: 2018, precipitation: 290, temp: 26.0, humidity: 79 }, { year: 2019, precipitation: 250, temp: 25.8, humidity: 77 }, { year: 2020, precipitation: 856, temp: 24.8, humidity: 88 }, { year: 2021, precipitation: 151, temp: 26.2, humidity: 75 }, { year: 2022, precipitation: 500, temp: 25.3, humidity: 86 }, { year: 2023, precipitation: 650, temp: 25.7, humidity: 89 }, { year: 2024, precipitation: 390, temp: 25.9, humidity: 83 }, ],
  '부산': [ { year: 2015, precipitation: 320, temp: 25.0, humidity: 80 }, { year: 2016, precipitation: 410, temp: 25.6, humidity: 84 }, { year: 2017, precipitation: 380, temp: 26.0, humidity: 83 }, { year: 2018, precipitation: 350, temp: 26.5, humidity: 81 }, { year: 2019, precipitation: 420, temp: 26.3, humidity: 85 }, { year: 2020, precipitation: 580, temp: 25.5, humidity: 89 }, { year: 2021, precipitation: 283, temp: 26.7, humidity: 80 }, { year: 2022, precipitation: 480, temp: 25.9, humidity: 87 }, { year: 2023, precipitation: 590, temp: 26.1, humidity: 90 }, { year: 2024, precipitation: 450, temp: 26.4, humidity: 86 }, ],
  '대구': [ { year: 2015, precipitation: 250, temp: 26.0, humidity: 75 }, { year: 2016, precipitation: 330, temp: 26.5, humidity: 79 }, { year: 2017, precipitation: 310, temp: 27.0, humidity: 78 }, { year: 2018, precipitation: 280, temp: 27.5, humidity: 76 }, { year: 2019, precipitation: 300, temp: 27.2, humidity: 77 }, { year: 2020, precipitation: 490, temp: 26.3, humidity: 85 }, { year: 2021, precipitation: 250, temp: 27.8, humidity: 74 }, { year: 2022, precipitation: 410, temp: 26.7, humidity: 82 }, { year: 2023, precipitation: 520, temp: 26.9, humidity: 86 }, { year: 2024, precipitation: 360, temp: 27.1, humidity: 80 }, ],
  '광주': [ { year: 2015, precipitation: 340, temp: 25.8, humidity: 82 }, { year: 2016, precipitation: 400, temp: 26.3, humidity: 85 }, { year: 2017, precipitation: 370, temp: 26.8, humidity: 84 }, { year: 2018, precipitation: 360, temp: 27.3, humidity: 83 }, { year: 2019, precipitation: 410, temp: 27.0, humidity: 86 }, { year: 2020, precipitation: 620, temp: 26.1, humidity: 90 }, { year: 2021, precipitation: 310, temp: 27.5, humidity: 81 }, { year: 2022, precipitation: 510, temp: 26.5, humidity: 88 }, { year: 2023, precipitation: 630, temp: 26.7, humidity: 91 }, { year: 2024, precipitation: 470, temp: 27.2, humidity: 87 }, ],
  '강릉': [ { year: 2015, precipitation: 290, temp: 23.5, humidity: 80 }, { year: 2016, precipitation: 320, temp: 24.1, humidity: 83 }, { year: 2017, precipitation: 480, temp: 24.5, humidity: 88 }, { year: 2018, precipitation: 260, temp: 25.0, humidity: 78 }, { year: 2019, precipitation: 230, temp: 24.8, humidity: 76 }, { year: 2020, precipitation: 550, temp: 23.9, humidity: 90 }, { year: 2021, precipitation: 180, temp: 25.2, humidity: 75 }, { year: 2022, precipitation: 450, temp: 24.3, humidity: 87 }, { year: 2023, precipitation: 580, temp: 24.7, humidity: 91 }, { year: 2024, precipitation: 350, temp: 24.9, humidity: 84 }, ],
  '제주': [ { year: 2015, precipitation: 380, temp: 26.0, humidity: 85 }, { year: 2016, precipitation: 450, temp: 26.6, humidity: 88 }, { year: 2017, precipitation: 420, temp: 27.1, humidity: 87 }, { year: 2018, precipitation: 390, temp: 27.6, humidity: 86 }, { year: 2019, precipitation: 480, temp: 27.3, humidity: 89 }, { year: 2020, precipitation: 590, temp: 26.5, humidity: 92 }, { year: 2021, precipitation: 350, temp: 27.8, humidity: 84 }, { year: 2022, precipitation: 530, temp: 26.9, humidity: 90 }, { year: 2023, precipitation: 670, temp: 27.2, humidity: 93 }, { year: 2024, precipitation: 510, temp: 27.5, humidity: 89 }, ],
  '대전': [ { year: 2015, precipitation: 310, temp: 25.2, humidity: 79 }, { year: 2016, precipitation: 360, temp: 25.8, humidity: 83 }, { year: 2017, precipitation: 430, temp: 26.2, humidity: 86 }, { year: 2018, precipitation: 300, temp: 26.7, humidity: 80 }, { year: 2019, precipitation: 270, temp: 26.5, humidity: 78 }, { year: 2020, precipitation: 750, temp: 25.5, humidity: 89 }, { year: 2021, precipitation: 190, temp: 26.9, humidity: 76 }, { year: 2022, precipitation: 520, temp: 26.0, humidity: 87 }, { year: 2023, precipitation: 680, temp: 26.4, humidity: 90 }, { year: 2024, precipitation: 410, temp: 26.6, humidity: 84 }, ],
  '인천': [ { year: 2015, precipitation: 270, temp: 24.2, humidity: 77 }, { year: 2016, precipitation: 340, temp: 24.8, humidity: 81 }, { year: 2017, precipitation: 440, temp: 25.2, humidity: 84 }, { year: 2018, precipitation: 280, temp: 25.7, humidity: 78 }, { year: 2019, precipitation: 240, temp: 25.5, humidity: 76 }, { year: 2020, precipitation: 830, temp: 24.5, humidity: 87 }, { year: 2021, precipitation: 140, temp: 25.9, humidity: 74 }, { year: 2022, precipitation: 490, temp: 25.0, humidity: 85 }, { year: 2023, precipitation: 630, temp: 25.4, humidity: 88 }, { year: 2024, precipitation: 380, temp: 25.6, humidity: 82 }, ],
};

// 장마철 평년값 (1991-2020년 평균 기준, 샘플)
const normalYearData = {
  'precipitation': { '서울': 378.3, '부산': 341.1, '대구': 295.5, '광주': 380.1, '강릉': 360.4, '제주': 348.7, '대전': 375.2, '인천': 365.1 },
  'temp': { '서울': 24.9, '부산': 25.3, '대구': 26.1, '광주': 25.7, '강릉': 23.8, '제주': 26.2, '대전': 25.4, '인천': 24.5 },
  'humidity': { '서울': 80, '부산': 83, '대구': 78, '광주': 84, '강릉': 85, '제주': 86, '대전': 82, '인천': 81 },
};

// --- 컴포넌트 영역 ---

export default function App() {
  const [selectedCities, setSelectedCities] = useState(['서울', '부산']);
  const [yearRange, setYearRange] = useState([2015, 2024]);
  const [dataType, setDataType] = useState('precipitation');
  const [chartType, setChartType] = useState('line');

  const handleCityChange = (e) => {
    const options = e.target.options;
    const values = [];
    for (let i = 0, l = options.length; i < l; i++) {
      if (options[i].selected) {
        values.push(options[i].value);
      }
    }
    setSelectedCities(values);
  };
  
  const combinedChartData = useMemo(() => {
    const years = Array.from({ length: yearRange[1] - yearRange[0] + 1 }, (_, i) => yearRange[0] + i);
    
    return years.map(year => {
      const yearData = { year };
      selectedCities.forEach(city => {
        const cityYearData = mockWeatherData[city]?.find(d => d.year === year);
        yearData[`${city}_${dataType}`] = cityYearData?.[dataType];
      });
      return yearData;
    });
  }, [selectedCities, yearRange, dataType]);

  const tableData = useMemo(() => {
    return combinedChartData;
  }, [combinedChartData]);

  const downloadCSV = () => {
    if (tableData.length === 0) return;
    const headers = ['year'].concat(selectedCities.map(c => `${c}_${dataType}`));
    const csvContent = [
      headers.join(','),
      ...tableData.map(row => headers.map(header => row[header]).join(','))
    ].join('\n');
    
    const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `monsoon_data_${yearRange[0]}-${yearRange[1]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const dataTypeInfo = {
    precipitation: { name: "강수량", unit: "mm" },
    temp: { name: "평균 기온", unit: "°C" },
    humidity: { name: "평균 습도", unit: "%" },
  };

  return (
    <div className="bg-slate-100 min-h-screen p-4 sm:p-6 lg:p-8" style={{ fontFamily: "'Noto Sans KR', sans-serif" }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        .recharts-legend-item-text {
            color: #374151 !important; /* legend text color */
        }
      `}</style>
      <div className="max-w-screen-xl mx-auto">
        <header className="text-center mb-10">
          <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 tracking-tight pb-2">
            장마철 날씨 데이터 분석
          </h1>
          <p className="mt-2 text-lg text-slate-600">
            최신 기상 데이터를 다각적으로 비교하고 분석합니다.
          </p>
        </header>

        <div className="bg-white rounded-2xl shadow-xl p-4 sm:p-6">
          {/* --- 제어판 --- */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 border-b-2 border-slate-200 pb-6">
            <div className="lg:col-span-1">
              <label htmlFor="city-select" className="block text-sm font-bold text-slate-700 mb-2">지역 선택 (다중 선택 가능)</label>
              <select
                id="city-select"
                multiple
                value={selectedCities}
                onChange={handleCityChange}
                className="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 h-32 transition"
              >
                {Object.keys(cityInfo).map(city => (<option key={city} value={city}>{city}</option>))}
              </select>
            </div>
            <div className="lg:col-span-2 space-y-6">
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">기간 선택: {yearRange[0]}년 - {yearRange[1]}년</label>
                <div className="flex items-center space-x-4">
                    <span className="text-sm font-medium text-slate-500">{2015}</span>
                    <input type="range" min="2015" max="2024" value={yearRange[1]} onChange={(e) => setYearRange([yearRange[0], parseInt(e.target.value)])} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-cyan-500"/>
                    <span className="text-sm font-medium text-slate-500">{2024}</span>
                </div>
              </div>
               <div>
                  <label className="block text-sm font-bold text-slate-700 mb-2">데이터 선택</label>
                  <div className="flex space-x-2 rounded-lg bg-slate-200 p-1">
                    {Object.keys(dataTypeInfo).map(key => (
                      <button key={key} onClick={() => setDataType(key)} className={`w-full py-2 text-sm font-bold rounded-md transition-all duration-300 ${dataType === key ? 'bg-white shadow-md text-cyan-600' : 'text-slate-600 hover:bg-slate-300'}`}>
                        {dataTypeInfo[key].name}
                      </button>
                    ))}
                  </div>
              </div>
            </div>
          </div>

          {/* --- 차트 --- */}
          <div className="p-4 rounded-xl border border-slate-200 bg-slate-50 mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                  <h3 className="text-xl font-bold text-slate-800 mb-2 sm:mb-0">연도별 비교 분석</h3>
                  <div className="flex space-x-1 rounded-lg bg-slate-200 p-1">
                      <button onClick={() => setChartType('line')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition ${chartType === 'line' ? 'bg-white shadow text-cyan-600' : 'text-slate-500'}`}>Line</button>
                      <button onClick={() => setChartType('bar')} className={`px-4 py-1.5 text-sm font-bold rounded-md transition ${chartType === 'bar' ? 'bg-white shadow text-cyan-600' : 'text-slate-500'}`}>Bar</button>
                  </div>
              </div>
              <div className="w-full h-[400px]">
                <ResponsiveContainer>
                  {chartType === 'line' ? (
                    <LineChart data={combinedChartData} margin={{ top: 5, right: 20, left: 0, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                      <XAxis dataKey="year" fontSize={12} tick={{ fill: '#64748b' }} />
                      <YAxis fontSize={12} tick={{ fill: '#64748b' }} label={{ value: dataTypeInfo[dataType].unit, position: 'insideTopLeft', dx: -10, dy: -10, fontSize:12, fill: '#94a3b8' }} />
                      <Tooltip contentStyle={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', backdropFilter: 'blur(4px)', borderRadius: '0.5rem', borderColor: '#e2e8f0' }} />
                      <Legend />
                      {selectedCities.map(city => (
                        <Line key={city} type="monotone" dataKey={`${city}_${dataType}`} name={city} stroke={cityInfo[city].color} strokeWidth={2.5} dot={{ r: 4 }} activeDot={{ r: 7 }} />
                      ))}
                       {selectedCities.length === 1 && (
                         <ReferenceLine y={normalYearData[dataType][selectedCities[0]]} label={{value: "평년값", position: "insideTopRight", fill:"#64748b", fontWeight: 'bold'}} stroke="#64748b" strokeDasharray="4 4" />
                       )}
                    </LineChart>
                  ) : (
                    <BarChart data={combinedChartData} margin={{ top: 5, right: 20, left: 0, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                      <XAxis dataKey="year" fontSize={12} tick={{ fill: '#64748b' }} />
                      <YAxis fontSize={12} tick={{ fill: '#64748b' }} />
                      <Tooltip contentStyle={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', backdropFilter: 'blur(4px)', borderRadius: '0.5rem', borderColor: '#e2e8f0' }}/>
                      <Legend />
                      {selectedCities.map(city => (
                        <Bar key={city} dataKey={`${city}_${dataType}`} name={city} fill={cityInfo[city].color} />
                      ))}
                       {selectedCities.length === 1 && (
                         <ReferenceLine y={normalYearData[dataType][selectedCities[0]]} label={{value: "평년값", position: "top", fill:"#64748b", fontWeight: 'bold'}} stroke="#64748b" strokeDasharray="3 3" />
                       )}
                    </BarChart>
                  )}
                </ResponsiveContainer>
              </div>
            </div>

          {/* --- 데이터 테이블 --- */}
           <div className="mt-8">
               <div className="flex justify-between items-center mb-4">
                   <h3 className="text-xl font-bold text-slate-800">상세 데이터</h3>
                   <button onClick={downloadCSV} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 text-white text-sm font-bold rounded-lg hover:opacity-90 transition shadow-md">
                       CSV 다운로드
                   </button>
               </div>
               <div className="overflow-x-auto bg-white rounded-lg border border-slate-200 shadow-sm">
                   <table className="w-full text-sm text-left text-slate-600">
                       <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                           <tr>
                               <th scope="col" className="px-6 py-4 font-bold">연도</th>
                               {selectedCities.map(city => (
                                   <th key={city} scope="col" className="px-6 py-4 font-bold">{city} ({dataTypeInfo[dataType].unit})</th>
                               ))}
                           </tr>
                       </thead>
                       <tbody>
                           {tableData.map((row, index) => (
                               <tr key={row.year} className={`border-b border-slate-200 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'} hover:bg-cyan-50`}>
                                   <td className="px-6 py-4 font-bold text-slate-900">{row.year}</td>
                                   {selectedCities.map(city => (
                                       <td key={city} className="px-6 py-4">{row[`${city}_${dataType}`] ?? 'N/A'}</td>
                                   ))}
                               </tr>
                           ))}
                       </tbody>
                   </table>
               </div>
           </div>
        </div>

        <footer className="text-center mt-10 pt-6 border-t border-slate-200">
            <p className="text-sm text-slate-500">
              이 데이터는 기상청 과거 관측 자료를 기반으로 한 샘플이며 실제 값과 다를 수 있습니다.
            </p>
            <a href="https://data.kma.go.kr" target="_blank" rel="noopener noreferrer" className="text-cyan-600 hover:text-blue-700 hover:underline transition font-semibold">
              데이터 출처: 기상자료개방포털 (기상청)
            </a>
            <p className="text-xs text-slate-400 mt-2">최종 업데이트: 2025-06-26</p>
        </footer>
      </div>
    </div>
  );
}
